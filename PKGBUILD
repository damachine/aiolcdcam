# -----------------------------------------------------------------------------
# CoolerDash PKGBUILD
#
# @brief Arch Linux packaging script for CoolerDash (C99 LCD daemon)
# @details
#   - Handles build, install, dependencies, and packaging for Arch/AUR.
#   - All comments are in English for consistency.
#   - See README.md and AUR-README.md for details.
#
# @author damachine
# @copyright Copyright (c) 2025 damachine
# @license MIT
# @version 0.25.07.23.2
# @since 0.25.07.23.2
# @note
#   - Edit dependencies, paths, and user as needed for your system.
#   - All build steps follow C99 and project coding standards.
# @warning
#   - Do not run as root. Use dedicated user for security.
#   - Ensure all required dependencies are installed.
# @todo
#   - Add support for additional platforms and packaging formats.
# @see README.md, AUR-README.md
# -----------------------------------------------------------------------------

# Project coding standards and packaging notes (see README for details)
#
# Maintainer: DAMACHINE <christkue79@gmail.com>
#
# --- Dependency notes ---
# - 'cairo', 'libcurl-gnutls', 'coolercontrol' are required for core functionality
# - 'nvidia-utils' and 'lm_sensors' are optional for extended hardware monitoring
# - 'ttf-roboto' is required for proper font rendering on the LCD
# - All dependencies are documented in README and AUR-README
# ------------------------

pkgname=coolerdash
pkgver=$(cat VERSION)
pkgrel=1
pkgdesc="CoolerDash - LCD dashboard for CoolerControl"
arch=('x86_64')
url="https://github.com/damachine/coolerdash"
license=('MIT')
depends=('cairo' 'libcurl-gnutls' 'libinih' 'coolercontrol' 'ttf-roboto')
makedepends=('gcc' 'make' 'pkg-config')
optdepends=('nvidia-utils: for GPU temperature monitoring'
            'lm_sensors: for additional hardware monitoring')
backup=('etc/coolerdash/config.ini')
install=coolerdash.install
source=()
sha256sums=()

build() {
    echo "================================================================"
    plain ' '
    plain '         .--.  '
    plain '        |o_o | '
    plain '        |:_/ | '
    plain '       //   \ \ '
    plain '      (|     | ) '
    plain '      /'\''\_   _/'\''\ '
    plain '      \___)=(___/ '
    plain ' '

    # For local build: use current directory directly
    cd "$startdir"

    # Remove all previous tarball builds
    rm -rf coolerdash-*.pkg.* || true

    # Clean any previous builds
    make clean || true

    # Build with Arch Linux specific optimizations and C99 compliance
    make

    # Copy binary to $srcdir/bin for packaging
    mkdir -p "$srcdir/bin"
    cp -a bin/coolerdash "$srcdir/bin/coolerdash"

    # Copy all required files for packaging to $srcdir
    cp -a README.md "$srcdir/README.md"
    cp -a LICENSE "$srcdir/LICENSE"
    cp -a CHANGELOG.md "$srcdir/CHANGELOG.md"
    cp -a VERSION "$srcdir/VERSION"
    cp -a AUR-README.md "$srcdir/AUR-README.md"
    mkdir -p "$srcdir/images"
    cp -a images/shutdown.png "$srcdir/images/shutdown.png"
    mkdir -p "$srcdir/systemd"
    cp -a etc/systemd/coolerdash.service "$srcdir/systemd/coolerdash.service"
    mkdir -p "$srcdir/man"
    cp -a man/coolerdash.1 "$srcdir/man/coolerdash.1"
    mkdir -p "$srcdir/etc/coolerdash"
    cp -a etc/coolerdash/config.ini "$srcdir/etc/coolerdash/config.ini"
    echo "================================================================"
}

check() {
    # For local build: use current directory directly
    cd "$startdir"

    if [[ -f bin/coolerdash ]]; then
        echo "Build successful - binary created"
        #bin/coolerdash --help > /dev/null && echo "Help function works"
    else
        echo "ERROR: Binary not found"
        return 1
    fi
}

package() {
    # For local build: use current directory directly
    install -dm755 "$pkgdir/opt/coolerdash/bin"
    install -Dm755 bin/coolerdash "$pkgdir/opt/coolerdash/bin/coolerdash"
    install -dm755 "$pkgdir/opt/coolerdash/images"
    install -Dm644 images/shutdown.png "$pkgdir/opt/coolerdash/images/shutdown.png"
    install -Dm644 README.md "$pkgdir/opt/coolerdash/README.md"
    install -Dm644 LICENSE "$pkgdir/opt/coolerdash/LICENSE"
    install -Dm644 CHANGELOG.md "$pkgdir/opt/coolerdash/CHANGELOG.md"
    install -Dm644 systemd/coolerdash.service "$pkgdir/etc/systemd/system/coolerdash.service"
    install -Dm644 man/coolerdash.1 "$pkgdir/usr/share/man/man1/coolerdash.1"
    install -Dm644 VERSION "$pkgdir/opt/coolerdash/VERSION"
    install -Dm644 AUR-README.md "$pkgdir/opt/coolerdash/AUR-README.md"
    install -dm755 "$pkgdir/usr/bin"
    ln -sf /opt/coolerdash/bin/coolerdash "$pkgdir/usr/bin/coolerdash"
    install -Dm644 etc/coolerdash/config.ini "$pkgdir/etc/coolerdash/config.ini"
    install -dm755 "$pkgdir/run/coolerdash"
}
